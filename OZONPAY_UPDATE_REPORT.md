# –û—Ç—á–µ—Ç –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Ozon Pay

## üîç –ü—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑

–ü–æ—Å–ª–µ –∏–∑—É—á–µ–Ω–∏—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Ozon Pay (—Ñ–∞–π–ª `api_acq.md`) –±—ã–ª–∞ –≤—ã—è–≤–ª–µ–Ω–∞ **–ø–æ–ª–Ω–∞—è –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** –Ω–∞—à–µ–π –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º API.

### ‚ùå –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL API**
   - –ë—ã–ª–æ: `https://api.ozon.ru/acquiring/v1`
   - –°—Ç–∞–ª–æ: `https://payapi.ozon.ru/v1`

2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø—Ä–æ—Å–æ–≤**
   - API —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å `accessKey`, `amount.value`, `fiscalizationType`, etc.
   - –ù–∞—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∞ `merchant_id`, `amount` –≤ –∫–æ–ø–µ–π–∫–∞—Ö, etc.

3. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ–¥–ø–∏—Å–∏**
   - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—é –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–ª–µ–π
   - –ú—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ø–æ–¥–ø–∏—Å—å –æ—Ç –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

4. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–ª—é—á–µ–π**
   - –¢—Ä–µ–±—É–µ—Ç—Å—è: `AccessKey`, `SecretKey`, `NotificationSecretKey`
   - –ë—ã–ª–æ: `merchantId`, `secretKey`

5. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ webhook**
   - Webhook –ø–æ–¥–ø–∏—Å—å –∏–º–µ–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º `|`

## ‚úÖ –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –ü–µ—Ä–µ–ø–∏—Å–∞–Ω —Ñ–∞–π–ª `server/ozonpay.ts`

- **–ù–æ–≤—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã**: `OzonPayConfig`, `OrderItem`
- **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –ø–æ–¥–ø–∏—Å–∏**:
  - `createOrderSignature()` - –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤
  - `createDetailsSignature()` - –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
  - `verifyWebhookSignature()` - –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ webhook
- **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ API –∑–∞–ø—Ä–æ—Å–æ–≤**
- **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ URL endpoints**: `/createOrder`, `/getOrderDetails`, `/getOrderStatus`

### 2. –û–±–Ω–æ–≤–ª–µ–Ω —Ñ–∞–π–ª `server/routes-sqlite.ts`

- **Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞**: –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–¥ –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö (`orderID`, `extOrderID`, `transactionID`)
- **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤**: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ `OrderItem[]` –¥–ª—è API
- **–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞**: –æ–±–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–æ–≤—ã–º API
- **–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ–ø–ª–∞—Ç–∞**: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `update-ozonpay-fields.cjs`:
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è `ozonpay_payment_id`, `ozonpay_payment_url`, `ozonpay_transaction_id`
- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω—ã —Å—Ç–∞—Ä—ã–µ –ø–æ–ª—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–∞–±–ª–∏—Ü—ã `orders` –∏ `balance_topups`

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **OZONPAY_SETUP.md**: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∫–ª—é—á–∞—Ö –∏ API
- **OZON_PAY_SETUP_GUIDE.md**: –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫

## üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª—é—á–µ–π

–ü–æ–ª—É—á–µ–Ω—ã —Ä–µ–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –æ—Ç Ozon Pay:

```env
OZONPAY_ACCESS_KEY=f3c0b7c9-9d17-4aa7-94b2-7106649534c3
OZONPAY_SECRET_KEY=E6Wpm0o73sr67ZK7z6qvULn77BqG0lvR
OZONPAY_NOTIFICATION_SECRET_KEY=3UrW32FscjhqAmeJhuq14eZ8hPamZlz8
OZONPAY_API_URL=https://payapi.ozon.ru/v1
```

## üìã –§–∞–π–ª—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

1. **env-setup.txt** - –≥–æ—Ç–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
2. **setup-ozonpay.bat** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
3. **update-ozonpay-fields.cjs** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏**:
   ```bash
   copy env-setup.txt .env
   ```

2. **–û–±–Ω–æ–≤–∏—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö**:
   ```bash
   node update-ozonpay-fields.cjs
   ```

3. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä**:
   ```bash
   npm run dev
   ```

4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ**:
   - –°–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑ —Å –æ–ø–ª–∞—Ç–æ–π —á–µ—Ä–µ–∑ Ozon Pay
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤
   - –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –ø–æ–ª—É—á–µ–Ω–∏–∏ webhook'–æ–≤

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞ createOrder (–Ω–æ–≤–∞—è)
```json
{
  "accessKey": "f3c0b7c9-9d17-4aa7-94b2-7106649534c3",
  "amount": {
    "currencyCode": "643",
    "value": 5500
  },
  "enableFiscalization": false,
  "extId": "45",
  "fiscalizationType": "FISCAL_TYPE_SINGLE", 
  "paymentAlgorithm": "PAY_ALGO_SMS",
  "successUrl": "http://localhost:5000/payment/success",
  "failUrl": "http://localhost:5000/payment/fail",
  "notificationUrl": "http://localhost:5000/api/ozonpay/webhook",
  "requestSign": "–ø–æ–¥–ø–∏—Å—å",
  "items": [...]
}
```

### –ü–æ–¥–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
```
SHA256(accessKey + expiresAt + extId + fiscalizationType + paymentAlgorithm + currencyCode + value + secretKey)
```

### –ü–æ–¥–ø–∏—Å—å webhook
```
SHA256(accessKey|orderID|transactionID|extOrderID|amount|currencyCode|notificationSecretKey)
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–°—É–º–º—ã –≤ —Ä—É–±–ª—è—Ö**, –Ω–µ –≤ –∫–æ–ø–µ–π–∫–∞—Ö (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç –º–Ω–æ–≥–∏—Ö –¥—Ä—É–≥–∏—Ö –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö API)
2. **–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è**: `fiscalizationType`, `paymentAlgorithm`, `items`
3. **Webhook —Å—Ç–∞—Ç—É—Å—ã**: `Completed`, `Failed` (–Ω–µ `succeeded`/`failed`)
4. **–¢–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞**: `4111 1111 1111 1111`, `01/28`, `111`

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è Ozon Pay –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∞ –∏ —Ç–µ–ø–µ—Ä—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏. –í—Å–µ –º–µ—Ç–æ–¥—ã API, –∞–ª–≥–æ—Ä–∏—Ç–º—ã –ø–æ–¥–ø–∏—Å–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–≤–µ–¥–µ–Ω—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ Ozon Pay. 