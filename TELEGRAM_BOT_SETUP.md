# Настройка Telegram бота для подтверждения номеров телефонов

## Шаг 1: Создание бота

1. Откройте Telegram и найдите @BotFather
2. Отправьте команду `/newbot`
3. Введите имя бота (например: "Jungle Plants Verification Bot")
4. Введите username бота (например: "InvittingToTGbotik_bot")
5. Сохраните полученный токен

## Шаг 2: Настройка переменных окружения

Создайте файл `.env` в корне проекта и добавьте:

```env
TELEGRAM_BOT_TOKEN=ваш_токен_от_botfather
WEBHOOK_URL=https://ваш_домен.com/api/telegram/webhook
```

## Шаг 3: Обновление URL бота в коде

В файле `client/src/pages/auth-page.tsx` URL бота уже настроен:

```typescript
const telegramBotUrl = `https://t.me/InvittingToTGbotik_bot?start=${verificationToken}`;
```

Замените `InvittingToTGbotik_bot` на ваш реальный username бота.

## Шаг 4: Настройка webhook (для продакшена)

Для локальной разработки можно использовать ngrok:

1. Установите ngrok: `npm install -g ngrok`
2. Запустите: `ngrok http 5000`
3. Скопируйте HTTPS URL и обновите WEBHOOK_URL в .env
4. Установите webhook: 
   ```bash
   curl -X POST "https://api.telegram.org/bot<ВАШ_ТОКЕН>/setWebhook" \
        -H "Content-Type: application/json" \
        -d '{"url":"<NGROK_URL>/api/telegram/webhook"}'
   ```

## Шаг 5: Логика работы с токенами верификации

1. Пользователь заполняет форму регистрации с номером телефона
2. Система генерирует уникальный токен верификации
3. Появляется диалог с кнопкой "Перейти в Telegram бота"
4. Пользователь переходит по ссылке с токеном: `https://t.me/bot?start=TOKEN`
5. Бот получает токен через параметр start и привязывает к пользователю
6. Бот просит отправить контакт или номер телефона
7. Пользователь отправляет контакт
8. Бот сверяет номер с токеном и подтверждает в базе данных
9. Пользователь возвращается на сайт и нажимает "Я подтвердил номер"
10. Система проверяет подтверждение по токену и создает аккаунт

## Команды бота

- `/start [token]` - начало работы с ботом (токен передается автоматически)
- Отправка контакта - подтверждение номера телефона
- Отправка текста с номером - альтернативный способ подтверждения

## Структура базы данных

Создается таблица `pending_registrations`:
- `id` - уникальный идентификатор
- `phone` - номер телефона (нормализованный)
- `user_data` - JSON с данными пользователя
- `verification_token` - уникальный токен верификации
- `verified` - флаг подтверждения (0/1)
- `created_at` - время создания

## Безопасность

- Данные регистрации хранятся временно (24 часа)
- Номера телефонов нормализуются перед сохранением
- Каждая регистрация имеет уникальный токен верификации
- Токен передается через защищенную ссылку
- Автоматическая очистка старых записей
- Webhook защищен от спама

## Тестирование

1. Запустите сервер: `npm run dev`
2. Откройте страницу регистрации
3. Заполните форму с номером телефона
4. Нажмите "Зарегистрироваться"
5. В диалоге нажмите "Перейти в Telegram бота"
6. В боте нажмите /start и отправьте контакт
7. Вернитесь на сайт и нажмите "Я подтвердил номер"

## Troubleshooting

- Если бот не отвечает, проверьте TELEGRAM_BOT_TOKEN в .env
- Если webhook не работает, проверьте URL и доступность сервера
- Если токен не передается, проверьте URL бота в коде
- Логи сервера покажут детали ошибок верификации 