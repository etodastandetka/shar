# ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–π –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

## üìä –ü—Ä–æ–±–ª–µ–º–∞
–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–Ω–∏–º–∞–ª–æ **800-1500ms** –∏–∑-–∑–∞:
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ú–µ–¥–ª–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–µ—Å—Å–∏–∏ Express
- –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏

## üöÄ –†–µ—à–µ–Ω–∏–µ

### 1. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Å—Å–∏–∏ (`server/auth-sqlite.ts`)
```javascript
app.use(session({
  rolling: false,        // –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Å—Å–∏—é –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
  store: undefined,      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞–º—è—Ç—å (–±—ã—Å—Ç—Ä–µ–µ)
  name: 'sessionId'      // –ö–æ—Ä–æ—Ç–∫–æ–µ –∏–º—è cookie
}));
```

### 2. –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ deserializeUser
```javascript
const userCache = new Map<string, Express.User>();
passport.deserializeUser((id: string, done) => {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à —Å–Ω–∞—á–∞–ª–∞
  if (userCache.has(id)) {
    return done(null, userCache.get(id)!);
  }
  // –ö–µ—à–∏—Ä—É–µ–º –Ω–∞ 5 –º–∏–Ω—É—Ç
  userCache.set(id, sessionUser);
  setTimeout(() => userCache.delete(id), 5 * 60 * 1000);
});
```

### 3. –ë—ã—Å—Ç—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏
```javascript
export function fastSessionLogin(req, userData): Promise<Express.User> {
  return new Promise((resolve, reject) => {
    // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–ï–ó –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
    const sessionUser = userRecordToSessionUser(userData);
    req.login(sessionUser, { session: true }, (err) => {
      err ? reject(err) : resolve(sessionUser);
    });
  });
}
```

### 4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
```javascript
export async function fastRegisterWithSession(req, userData): Promise<Express.User> {
  // –û–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  db.run("INSERT INTO users...", [...]);
  
  // –ë—ã—Å—Ç—Ä–æ —Å–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ SELECT
  return await fastSessionLogin(req, newUserData);
}
```

## üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|---------------|-------------------|-----------|
| –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è | 800-1500ms | 200-500ms | **2-3x –±—ã—Å—Ç—Ä–µ–µ** |
| –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è | 600ms | 150ms | **4x –±—ã—Å—Ç—Ä–µ–µ** |
| –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î | 1 SELECT | 0 | **-100%** |

## üõ† –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ

### –°–±–æ—Ä–∫–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫:
```bash
npm run build
pm2 restart russkii-portal
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
```bash
node test-session-speed.js
```

## üìù –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- `server/auth-sqlite.ts` - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–µ—Å—Å–∏–π
- `server/routes-sqlite.ts` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±—ã—Å—Ç—Ä—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é  
- `test-session-speed.js` - —Ç–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## üéØ –ö–ª—é—á–µ–≤—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
1. ‚ùå –£–±—Ä–∞–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. ‚ö° –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Express session
3. üóÑÔ∏è –î–æ–±–∞–≤–∏–ª–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
4. üîÑ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ pending_registrations (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç)

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –°–µ—Å—Å–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ **2-3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ** üöÄ 